# ุนุฑุถ ุงูููู ุงูุฃุตูู ูู ุตูุญุฉ ุนุฑุถ ุงูุจุญุซ

## ๐ ุงููุตู

ุชู ุฅุถุงูุฉ ููุฒุฉ ุนุฑุถ ุงูููู ุงูุฃุตูู (ูุจู ุงูุชุนุฏููุงุช) ูู ุตูุญุฉ ุนุฑุถ ุงูุจุญุซ `ViewResearchPage.tsx`. ูุฐู ุงูููุฒุฉ ุชุณูุญ ููุจุงุญุซ ุจุฑุคูุฉ ูุชุญููู ุงููุณุฎุฉ ุงูุฃููู ูู ุงูุจุญุซ ูุจู ุฅุฌุฑุงุก ุฃู ุชุนุฏููุงุช.

## ๐ฏ ููู ูุนูู ุงููุธุงู

### 1. ุญูุธ ุงูุจูุงูุงุช ุงูุฃุตููุฉ

ุนูุฏูุง ูุทูุจ ุงููุญุฑุฑ ุชุนุฏููุงุช ุนูู ุงูุจุญุซุ ูุชู ุญูุธ ุงูุจูุงูุงุช ุงูุฃุตููุฉ ูู `research_revisions.original_data`:

```typescript
// ูู research-revision.entity.ts
@Column({ type: 'jsonb', nullable: true })
original_data: {
  abstract?: string;
  keywords?: string[];
  file_url?: string;
  cloudinary_public_id?: string;
  cloudinary_secure_url?: string;
};
```

### 2. ุนุฑุถ ุงูููู ุงูุฃุตูู

ูู `ViewResearchPage.tsx`ุ ูุชู ุนุฑุถ ุงูููู ุงูุฃุตูู ููุท ุฅุฐุง:
- ูุงู ููุงู ุชุนุฏููุงุช ููุฑุณูุฉ (`status: 'submitted'`)
- ูุงู ุงูุชุนุฏูู ุงูุฃูู ูุญุชูู ุนูู `original_data`
- ูุงู `original_data` ูุญุชูู ุนูู `cloudinary_secure_url` ุฃู `file_url`

```typescript
// Get submitted revisions and first revision for original data
const submittedRevisions = revisions.filter(r => r.status === 'submitted');
const hasSubmittedRevisions = submittedRevisions.length > 0;
const firstRevision = submittedRevisions.sort((a, b) => a.revision_number - b.revision_number)[0];
const hasOriginalFile = firstRevision?.original_data && 
  (firstRevision.original_data.cloudinary_secure_url || firstRevision.original_data.file_url);
```

## ๐จ ูุงุฌูุฉ ุงููุณุชุฎุฏู

### ูุจู ุงูุชุนุฏููุงุช (ูุง ุชูุฌุฏ ุชุนุฏููุงุช ููุฑุณูุฉ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ููู ุงูุจุญุซ ุงูุฑุฆูุณู                      โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ๐ ููู ุงูุจุญุซ (PDF)                 โ โ
โ โ RES-2025-0011 โข PDF Document       โ โ
โ โ                   [ุชุญููู ุงูุจุญุซ] โฌ๏ธ โ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### ุจุนุฏ ุงูุชุนุฏููุงุช (ุชูุฌุฏ ุชุนุฏููุงุช ููุฑุณูุฉ)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ููู ุงูุจุญุซ ุงูุฃุตูู (ูุจู ุงูุชุนุฏููุงุช)      โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ๐ ุงูููู ุงูุฃุตูู (PDF)              โ โ
โ โ RES-2025-0011 โข ุงููุณุฎุฉ ุงูุฃููู ูุจู   โ โ
โ โ ุงูุชุนุฏููุงุช    [ุชุญููู ุงูููู ุงูุฃุตูู] โฌ๏ธโ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ ููู ุงูุจุญุซ ุงูุญุงูู (ุจุนุฏ ุงูุชุนุฏููุงุช)      โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ โ ๐ ุงูููู ุงูุญุงูู (PDF)              โ โ
โ โ RES-2025-0011 โข ุงููุณุฎุฉ ุงููุนุฏูุฉ      โ โ
โ โ (2 ุชุนุฏูู)  [ุชุญููู ุงููุณุฎุฉ ุงูุญุงููุฉ] โฌ๏ธโ โ
โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐จ ุงูุชุตููู

### ุงูููู ุงูุฃุตูู
- **ุงูููู**: ุจููุณุฌู (Purple)
- **ุงูุฎูููุฉ**: `from-purple-50 to-purple-100`
- **ุงูุญุฏูุฏ**: `border-purple-200`
- **ุงูุฃููููุฉ**: `text-purple-600`
- **ุงูุฒุฑ**: `bg-purple-600 hover:bg-purple-700`

### ุงูููู ุงูุญุงูู
- **ุงูููู**: ุฃุฒุฑู (Blue)
- **ุงูุฎูููุฉ**: `from-blue-50 to-blue-100`
- **ุงูุญุฏูุฏ**: `border-blue-200`
- **ุงูุฃููููุฉ**: `text-blue-600`
- **ุงูุฒุฑ**: `bg-[#0D3B66] hover:bg-[#0D3B66]/90`

## ๐ ุงูุฏูุงู ุงูุฌุฏูุฏุฉ

### `handleDownloadOriginalPDF()`

```typescript
const handleDownloadOriginalPDF = async () => {
  // Get the first submitted revision to access original_data
  const firstRevision = revisions
    .filter(r => r.status === 'submitted')
    .sort((a, b) => a.revision_number - b.revision_number)[0];

  const originalCloudinaryUrl = firstRevision?.original_data?.cloudinary_secure_url;
  const originalFileUrl = firstRevision?.original_data?.file_url;

  if (!originalCloudinaryUrl && !originalFileUrl) {
    toast.error('ูุง ููุฌุฏ ููู ุฃุตูู ููุชุญููู');
    return;
  }

  try {
    toast.loading('ุฌุงุฑู ุชุญููู ุงูููู ุงูุฃุตูู...', { id: 'download-original-pdf' });
    await downloadResearchPdf(originalCloudinaryUrl, originalFileUrl, research?.research_number || 'original');
    toast.success('ุชู ุจุฏุก ุงูุชุญููู', { id: 'download-original-pdf' });
  } catch (error) {
    toast.error('ูุดู ุชุญููู ุงูููู ุงูุฃุตูู', { id: 'download-original-pdf' });
    console.error('Error downloading original PDF:', error);
  }
};
```

## ๐ ุชุฏูู ุงูุนูู

### ุงูุณููุงุฑูู 1: ุจุญุซ ุจุฏูู ุชุนุฏููุงุช

```
1. ุงูุจุงุญุซ ูุฑูุน ุจุญุซ ุฌุฏูุฏ
   โ
2. research.file_url = "file_v0.pdf"
   research.cloudinary_secure_url = "cloudinary://..."
   โ
3. ูู ViewResearchPage:
   - ูุธูุฑ: "ููู ุงูุจุญุซ ุงูุฑุฆูุณู"
   - ูุง ูุธูุฑ: "ููู ุงูุจุญุซ ุงูุฃุตูู"
```

### ุงูุณููุงุฑูู 2: ุจุญุซ ูุน ุชุนุฏูู ูุงุญุฏ

```
1. ุงููุญุฑุฑ ูุทูุจ ุชุนุฏููุงุช
   โ
2. ูุชู ุฅูุดุงุก revision ูุน ุญูุธ ุงูุจูุงูุงุช ุงูุฃุตููุฉ:
   revision.original_data = {
     file_url: "file_v0.pdf",
     cloudinary_secure_url: "cloudinary://...",
     abstract: "ุงูููุฎุต ุงูุฃุตูู",
     keywords: ["ูููุฉ1", "ูููุฉ2"]
   }
   โ
3. ุงูุจุงุญุซ ูุฑูุน ููู ูุนุฏู
   โ
4. research.file_url = "file_v1.pdf" (ุชู ุงูุงุณุชุจุฏุงู)
   revision.file_url = "file_v1.pdf"
   revision.status = "submitted"
   โ
5. ูู ViewResearchPage:
   - ูุธูุฑ: "ููู ุงูุจุญุซ ุงูุฃุตูู (ูุจู ุงูุชุนุฏููุงุช)" โ ูู revision.original_data
   - ูุธูุฑ: "ููู ุงูุจุญุซ ุงูุญุงูู (ุจุนุฏ ุงูุชุนุฏููุงุช)" โ ูู research.file_url
```

### ุงูุณููุงุฑูู 3: ุจุญุซ ูุน ุชุนุฏููุงุช ูุชุนุฏุฏุฉ

```
1. ุงูุชุนุฏูู ุงูุฃูู:
   revision[0].original_data.file_url = "file_v0.pdf" (ุงูุฃุตูู)
   revision[0].file_url = "file_v1.pdf"
   research.file_url = "file_v1.pdf"
   
2. ุงูุชุนุฏูู ุงูุซุงูู:
   revision[1].original_data.file_url = "file_v1.pdf"
   revision[1].file_url = "file_v2.pdf"
   research.file_url = "file_v2.pdf"
   
3. ูู ViewResearchPage:
   - "ููู ุงูุจุญุซ ุงูุฃุตูู" โ ูู revision[0].original_data (file_v0.pdf)
   - "ููู ุงูุจุญุซ ุงูุญุงูู" โ ูู research.file_url (file_v2.pdf)
   - ุนุฏุฏ ุงูุชุนุฏููุงุช: 2
```

## โ ุงููููุฒุงุช

1. **ุนุฑุถ ุงูููู ุงูุฃุตูู**: ูููู ููุจุงุญุซ ุฑุคูุฉ ูุชุญููู ุงููุณุฎุฉ ุงูุฃููู ูู ุงูุจุญุซ
2. **ุชูููุฒ ูุงุถุญ**: ุฃููุงู ูุฎุชููุฉ ููููู ุงูุฃุตูู (ุจููุณุฌู) ูุงูุญุงูู (ุฃุฒุฑู)
3. **ูุนูููุงุช ุฏูููุฉ**: ุนุฑุถ ุนุฏุฏ ุงูุชุนุฏููุงุช ุงูููุฑุณูุฉ
4. **ุชุญููู ูุจุงุดุฑ**: ุงุณุชุฎุฏุงู ููุณ ูุธุงู ุงูุชุญููู ุงูููุญุณูู ูู Cloudinary
5. **ูุงุฌูุฉ ุฏููุงููููุฉ**: ุชุชุบูุฑ ุงูุนูุงููู ูุงูุฃูุตุงู ุญุณุจ ุญุงูุฉ ุงูุจุญุซ

## ๐งช ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ 1: ุจุญุซ ุจุฏูู ุชุนุฏููุงุช
```
โ ูุธูุฑ "ููู ุงูุจุญุซ ุงูุฑุฆูุณู" ููุท
โ ูุง ูุธูุฑ "ููู ุงูุจุญุซ ุงูุฃุตูู"
โ ุฒุฑ ุงูุชุญููู ูุนูู ุจุดูู ุตุญูุญ
```

### ุงุฎุชุจุงุฑ 2: ุจุญุซ ูุน ุชุนุฏูู ูุงุญุฏ
```
โ ูุธูุฑ "ููู ุงูุจุญุซ ุงูุฃุตูู (ูุจู ุงูุชุนุฏููุงุช)"
โ ูุธูุฑ "ููู ุงูุจุญุซ ุงูุญุงูู (ุจุนุฏ ุงูุชุนุฏููุงุช)"
โ ุนุฏุฏ ุงูุชุนุฏููุงุช = 1
โ ุชุญููู ุงูููู ุงูุฃุตูู ูุนูู
โ ุชุญููู ุงูููู ุงูุญุงูู ูุนูู
```

### ุงุฎุชุจุงุฑ 3: ุจุญุซ ูุน ุชุนุฏููุงุช ูุชุนุฏุฏุฉ
```
โ ูุธูุฑ ุงูููู ุงูุฃุตูู ูู ุฃูู revision
โ ูุธูุฑ ุงูููู ุงูุญุงูู ูู research
โ ุนุฏุฏ ุงูุชุนุฏููุงุช ุตุญูุญ (ูุซูุงู: 3 ุชุนุฏูู)
โ ุฌููุน ุฃุฒุฑุงุฑ ุงูุชุญููู ุชุนูู
```

## ๐ฆ ุงููููุงุช ุงูููุนุฏูุฉ

### `/apps/frontend/src/pages/dashboard/researcher/ViewResearchPage.tsx`

**ุงูุชุบููุฑุงุช:**
1. ุฅุถุงูุฉ ุฏุงูุฉ `handleDownloadOriginalPDF()`
2. ุฅุถุงูุฉ ูุชุบูุฑุงุช ููุชุญูู ูู ูุฌูุฏ ุชุนุฏููุงุช:
   - `submittedRevisions`
   - `hasSubmittedRevisions`
   - `firstRevision`
   - `hasOriginalFile`
3. ุฅุถุงูุฉ ูุณู "ููู ุงูุจุญุซ ุงูุฃุตูู (ูุจู ุงูุชุนุฏููุงุช)"
4. ุชุญุฏูุซ ูุณู "ููู ุงูุจุญุซ ุงูุฑุฆูุณู" ููุตุจุญ ุฏููุงูููู

## ๐ ุงููููุงุช ุฐุงุช ุงูุตูุฉ

- `/apps/backend/src/database/entities/research-revision.entity.ts` - ุชุนุฑูู `original_data`
- `/apps/frontend/src/services/research-revisions.service.ts` - ููุน `ResearchRevision`
- `/apps/frontend/src/utils/downloadFile.ts` - ุฏูุงู ุงูุชุญููู
- `FILE_REPLACEMENT_SYSTEM.md` - ุชูุซูู ูุธุงู ุงุณุชุจุฏุงู ุงููููุงุช

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

ุงูุขู ุงูุจุงุญุซ ููููู:
- โ ุฑุคูุฉ ุงูููู ุงูุฃุตูู ุงูุฐู ุฑูุนู ุฃูู ูุฑุฉ
- โ ุฑุคูุฉ ุงูููู ุงูุญุงูู ุจุนุฏ ุงูุชุนุฏููุงุช
- โ ุชุญููู ุฃู ูู ุงูููููู
- โ ูุนุฑูุฉ ุนุฏุฏ ุงูุชุนุฏููุงุช ุงูุชู ุชู ุฅุฌุฑุงุคูุง
- โ ุงูุชูููุฒ ุจุณูููุฉ ุจูู ุงูููู ุงูุฃุตูู ูุงูุญุงูู

---

**ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ:** Cascade AI  
**ุงูุชุงุฑูุฎ:** 2025-01-23  
**ุงูุฅุตุฏุงุฑ:** 1.0.0
