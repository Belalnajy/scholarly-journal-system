# عرض التعديلات للمحكمين - دليل التحديث

## 🎯 الهدف

السماح للمحكمين برؤية التعديلات التي أجراها الباحث على البحث، بما في ذلك:
- ملاحظات الباحث حول التعديلات
- الملف الجديد المعدل
- مقارنة بين البيانات القديمة والجديدة (الملخص والكلمات المفتاحية)

## 📝 التحديثات المنفذة

### 1. صفحة نموذج التقييم (EvaluationFormPage)

**الملف:** `/apps/frontend/src/pages/dashboard/EvaluationFormPage.tsx`

#### التغييرات:
- ✅ إضافة استيراد `researchRevisionsService`
- ✅ إضافة state للتعديلات: `revisions`
- ✅ تحميل التعديلات مع بيانات البحث
- ✅ عرض قسم "تعديلات الباحث" إذا كانت هناك تعديلات مرسلة

#### القسم الجديد:
```tsx
{/* Revision History - Show if there are submitted revisions */}
{revisions.filter(r => r.status === 'submitted').length > 0 && (
  <div className="bg-gradient-to-r from-orange-50 to-orange-100...">
    {/* عرض التعديلات */}
  </div>
)}
```

### 2. صفحة تفاصيل المراجعة (ReviewDetailsPage)

**الملف:** `/apps/frontend/src/pages/dashboard/ReviewDetailsPage.tsx`

#### التغييرات:
- ✅ إضافة استيراد `researchRevisionsService`
- ✅ إضافة state للتعديلات: `revisions`
- ✅ تحميل التعديلات مع بيانات البحث
- ✅ عرض قسم "تعديلات الباحث" قبل قسم التعليقات

## 🎨 واجهة المستخدم

### قسم تعديلات الباحث

```
┌────────────────────────────────────────────────────────────┐
│ تعديلات الباحث                                            │
│ الباحث قام بإجراء تعديلات على البحث بناءً على ملاحظاتك   │
├────────────────────────────────────────────────────────────┤
│ ┌──────────────────────────────────────────────────────┐   │
│ │ 🟠 المراجعة #1          📅 15 مارس 2024            │   │
│ │                                                      │   │
│ │ ملاحظات الباحث حول التعديلات:                      │   │
│ │ ┌──────────────────────────────────────────────┐     │   │
│ │ │ تم إجراء التعديلات التالية:                │     │   │
│ │ │ ✅ تحسين المنهجية                           │     │   │
│ │ │ ✅ إضافة 15 مرجع حديث                       │     │   │
│ │ │ ✅ إضافة جداول توضيحية                      │     │   │
│ │ └──────────────────────────────────────────────┘     │   │
│ │                                                      │   │
│ │ [📥 تحميل الملف المعدل (PDF)]                      │   │
│ └──────────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────────┤
│ مقارنة البيانات                                           │
│ ┌─────────────────────┐  ┌─────────────────────┐          │
│ │ ✖ الملخص الأصلي    │  │ ✔ الملخص المعدل    │          │
│ │ [غير متوفر]        │  │ ملخص محسن ومفصل... │          │
│ └─────────────────────┘  └─────────────────────┘          │
│                                                            │
│ الكلمات المفتاحية الحالية:                                │
│ 🏷️ ذكاء اصطناعي  🏷️ تعليم  🏷️ تقنية                   │
└────────────────────────────────────────────────────────────┘
```

## 🔄 تدفق العمل

### السيناريو الكامل:

```
1. المحكم يقيم البحث الأول
   ↓
   يوصي بـ "يحتاج تعديلات"
   
2. المحرر يطلب تعديلات من الباحث
   ↓
   يتم إنشاء revision request
   
3. الباحث يعدل البحث
   ↓
   - يعدل الملخص
   - يعدل الكلمات المفتاحية
   - يرفع ملف جديد
   - يكتب ملاحظاته
   ↓
   يرسل التعديلات
   
4. المحكم يفتح صفحة التقييم/التفاصيل
   ↓
   يرى قسم "تعديلات الباحث" يحتوي على:
   ✅ رقم المراجعة (#1, #2, etc.)
   ✅ تاريخ إرسال التعديل
   ✅ ملاحظات الباحث الكاملة
   ✅ زر لتحميل الملف المعدل
   ✅ مقارنة بين الملخص القديم والجديد
   ✅ الكلمات المفتاحية الحالية
   
5. المحكم يراجع التعديلات
   ↓
   يقيم البحث المعدل
```

## 📊 البيانات المعروضة

### 1. معلومات التعديل
```typescript
{
  revision_number: 1,           // رقم المراجعة
  revision_notes: "...",        // ملاحظات الباحث
  file_url: "...",             // رابط الملف المعدل
  submitted_at: "2024-03-15",  // تاريخ الإرسال
  status: "submitted"          // الحالة
}
```

### 2. البيانات الحالية
```typescript
{
  abstract: "الملخص المعدل...",
  keywords: ["كلمة1", "كلمة2", "كلمة3"],
  file_url: "رابط الملف الجديد"
}
```

## 🎯 المميزات

### للمحكم:
- ✅ **رؤية واضحة للتعديلات**: يرى بالضبط ما قام الباحث بتعديله
- ✅ **ملاحظات الباحث**: يفهم ما تم تنفيذه من التعديلات المطلوبة
- ✅ **الملف الجديد**: يمكنه تحميل ومراجعة النسخة المعدلة
- ✅ **مقارنة البيانات**: يرى الفرق بين القديم والجديد
- ✅ **تعديلات متعددة**: يرى جميع التعديلات مرتبة حسب الرقم

### للنظام:
- ✅ **شفافية كاملة**: كل شيء موثق ومرئي
- ✅ **تتبع التغييرات**: سجل كامل لكل تعديل
- ✅ **تحسين الجودة**: المحكم يرى التحسينات بوضوح

## 💻 الكود المضاف

### تحميل التعديلات:
```typescript
const [revisions, setRevisions] = useState<ResearchRevision[]>([]);

const loadResearch = async (researchId: string) => {
  const [data, revisionsData] = await Promise.all([
    researchService.getById(researchId),
    researchRevisionsService.getByResearch(researchId),
  ]);
  
  setResearch(data);
  setRevisions(revisionsData);
};
```

### عرض التعديلات:
```tsx
{revisions.filter(r => r.status === 'submitted').length > 0 && (
  <div className="bg-gradient-to-r from-orange-50 to-orange-100...">
    {/* Header */}
    <div className="p-6 border-b border-orange-200">
      <h2>تعديلات الباحث</h2>
    </div>
    
    {/* Revisions List */}
    <div className="p-6 space-y-4">
      {revisions
        .filter(r => r.status === 'submitted')
        .sort((a, b) => b.revision_number - a.revision_number)
        .map((revision) => (
          // عرض كل تعديل
        ))}
    </div>
    
    {/* Data Comparison */}
    <div className="p-6 bg-white border-t">
      {/* مقارنة الملخص والكلمات المفتاحية */}
    </div>
  </div>
)}
```

## 🧪 الاختبار

### خطوات الاختبار:

1. **قدم بحث جديد كباحث**
   - الملخص: "ملخص أصلي"
   - الكلمات: "كلمة1, كلمة2"

2. **المحكم يقيم ويوصي بتعديلات**

3. **المحرر يطلب تعديلات**

4. **الباحث يعدل:**
   - الملخص → "ملخص معدل ومحسن"
   - الكلمات → "كلمة1, كلمة2, كلمة3"
   - ملاحظات: "تم تحسين المنهجية وإضافة مراجع"
   - يرفع ملف جديد

5. **المحكم يفتح صفحة التقييم:**
   - ✅ يجب أن يرى قسم "تعديلات الباحث"
   - ✅ يجب أن يرى "المراجعة #1"
   - ✅ يجب أن يرى ملاحظات الباحث
   - ✅ يجب أن يرى زر تحميل الملف المعدل
   - ✅ يجب أن يرى الملخص الجديد
   - ✅ يجب أن يرى الكلمات المفتاحية الجديدة

6. **المحكم يفتح صفحة التفاصيل:**
   - ✅ نفس المعلومات يجب أن تظهر

## 📁 الملفات المعدلة

1. **`/apps/frontend/src/pages/dashboard/EvaluationFormPage.tsx`**
   - إضافة state للتعديلات
   - تحميل التعديلات
   - عرض قسم التعديلات

2. **`/apps/frontend/src/pages/dashboard/ReviewDetailsPage.tsx`**
   - إضافة state للتعديلات
   - تحميل التعديلات
   - عرض قسم التعديلات

## ⚠️ ملاحظات مهمة

### 1. الملخص الأصلي
حالياً يعرض "[الملخص القديم غير متوفر]" لأننا لا نحفظ نسخة من البيانات القديمة.

**لحفظ البيانات القديمة (اختياري):**
```typescript
// في research-revisions entity
@Column({ type: 'jsonb', nullable: true })
original_data: {
  abstract?: string;
  keywords?: string[];
  file_url?: string;
};
```

### 2. تحميل الملفات
الأزرار حالياً للعرض فقط. يجب ربطها بروابط التحميل الفعلية:
```tsx
<a 
  href={revision.file_url} 
  download 
  target="_blank"
  className="..."
>
  تحميل الملف المعدل
</a>
```

### 3. التعديلات المتعددة
النظام يدعم تعديلات متعددة (#1, #2, #3...) ويعرضها جميعاً مرتبة من الأحدث للأقدم.

## ✅ الخلاصة

الآن المحكم يمكنه:
- ✅ رؤية جميع التعديلات التي أجراها الباحث
- ✅ قراءة ملاحظات الباحث حول كل تعديل
- ✅ تحميل الملف المعدل
- ✅ مقارنة البيانات الجديدة بالقديمة
- ✅ تتبع رقم المراجعة والتاريخ

هذا يوفر **شفافية كاملة** في عملية المراجعة ويساعد المحكم على اتخاذ قرار مستنير بناءً على التعديلات المنفذة.

---

**تم التطوير بواسطة:** Cascade AI  
**التاريخ:** 2024  
**الإصدار:** 1.0.0
