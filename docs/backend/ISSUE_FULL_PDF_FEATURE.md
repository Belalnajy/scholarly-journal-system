# ميزة رفع ملف PDF كامل للعدد

## نظرة عامة
تتيح هذه الميزة للأدمن/المحرر رفع ملف PDF واحد يحتوي على جميع مقالات العدد مجمعة، بحيث يمكن للزوار تحميل العدد الكامل في ملف واحد.

## المكونات

### Backend

#### 1. Database
**Entity: `issue.entity.ts`**
- `issue_pdf_url`: رابط ملف PDF للعدد الكامل
- `issue_pdf_public_id`: معرف الملف في Cloudinary

#### 2. API Endpoint
**POST `/api/issues/:id/upload-full-pdf`**
- **الصلاحيات:** Admin, Editor فقط
- **المدخلات:** ملف PDF (حتى 50MB)
- **الوظيفة:**
  1. حذف الملف القديم من Cloudinary (إن وجد)
  2. رفع الملف الجديد
  3. تحديث معلومات العدد
  4. إرجاع بيانات العدد المحدثة

#### 3. Service Methods

**CloudinaryService.uploadIssuePdf()**
```typescript
async uploadIssuePdf(
  fileBuffer: Buffer,
  issueNumber: string,
  fileName: string
): Promise<CloudinaryUploadResult>
```
- يرفع الملف إلى `issues/full-pdfs/{issueNumber}/`
- يستخدم `issue_{issueNumber}_full` كـ public_id

**IssuesService.uploadFullIssuePdf()**
```typescript
async uploadFullIssuePdf(
  issueId: string,
  fileBuffer: Buffer,
  fileName: string,
  fileSize: number
): Promise<Issue>
```

### Frontend

#### 1. Service Method (سيتم إضافته)
**`issuesService.uploadFullIssuePdf()`**
```typescript
async uploadFullIssuePdf(
  issueId: string,
  file: File
): Promise<Issue>
```

#### 2. UI Components (سيتم إضافتها)

**في صفحة إدارة الأعداد:**
- زر "رفع ملف العدد الكامل"
- Modal لرفع الملف
- معاينة الملف المختار
- Progress bar أثناء الرفع

**في صفحة العدد للزوار:**
- زر "تحميل العدد الكامل (PDF)"
- يظهر فقط إذا كان الملف موجود

## سير العمل

### 1. رفع ملف العدد الكامل
```
الأدمن → يفتح صفحة إدارة الأعداد
       → يضغط "رفع ملف العدد الكامل"
       → يختار ملف PDF (جميع المقالات مجمعة)
       → يرفع الملف
       → يتم حفظ الملف على Cloudinary
       → يتم تحديث بيانات العدد
```

### 2. تحميل العدد الكامل (للزوار)
```
الزائر → يفتح صفحة العدد
       → يضغط "تحميل العدد الكامل"
       → يتم تحميل ملف PDF واحد يحتوي على جميع المقالات
```

## الميزات الأمنية

### 1. التحقق من الصلاحيات
- فقط Admin و Editor يمكنهم رفع الملف
- الزوار يمكنهم فقط التحميل

### 2. التحقق من نوع الملف
```typescript
if (file.mimetype !== 'application/pdf') {
  throw new BadRequestException('نوع الملف غير مدعوم. يرجى رفع ملف PDF فقط');
}
```

### 3. التحقق من حجم الملف
- الحد الأقصى: 50 ميجابايت

### 4. استبدال الملف القديم
- يتم حذف الملف القديم من Cloudinary تلقائياً عند رفع ملف جديد

## حالات الاستخدام

### 1. نشر عدد جديد
```
الأدمن → ينشئ العدد
       → يضيف المقالات
       → يجمع جميع المقالات في ملف PDF واحد
       → يرفع الملف الكامل
       → ينشر العدد
```

### 2. تحديث العدد
```
الأدمن → يعدل على بعض المقالات
       → يجمع المقالات المحدثة في ملف PDF جديد
       → يرفع الملف الجديد
       → يتم استبدال الملف القديم تلقائياً
```

### 3. تحميل العدد (للزوار)
```
الزائر → يتصفح الأعداد
       → يختار عدد معين
       → يضغط "تحميل العدد الكامل"
       → يحصل على ملف PDF واحد يحتوي على:
         - الغلاف
         - جميع المقالات
         - الفهرس
         - أي محتوى إضافي
```

## الاختبار

### 1. اختبار Backend
```bash
# Test upload endpoint
curl -X POST http://localhost:3000/api/issues/{id}/upload-full-pdf \
  -H "Authorization: Bearer {admin_token}" \
  -F "file=@full_issue.pdf"
```

### 2. اختبار Frontend
1. تسجيل دخول كـ Admin
2. الذهاب لصفحة إدارة الأعداد
3. اختيار عدد
4. الضغط على "رفع ملف العدد الكامل"
5. اختيار ملف PDF
6. الضغط على "رفع"
7. التحقق من نجاح الرفع
8. فتح صفحة العدد كزائر
9. الضغط على "تحميل العدد الكامل"
10. التحقق من تحميل الملف الصحيح

## الأخطاء الشائعة

### 1. "نوع الملف غير مدعوم"
**السبب:** الملف ليس PDF
**الحل:** استخدم ملف PDF فقط

### 2. "حجم الملف كبير جداً"
**السبب:** حجم الملف أكبر من 50MB
**الحل:** ضغط الملف أو تقليل جودة الصور

### 3. "فشل رفع الملف"
**السبب:** مشكلة في الاتصال بـ Cloudinary
**الحل:** التحقق من إعدادات Cloudinary في `.env`

## أفضل الممارسات

### 1. تجهيز ملف العدد الكامل
- ✅ اجمع جميع المقالات بترتيب منطقي
- ✅ أضف غلاف احترافي
- ✅ أضف فهرس المحتويات
- ✅ أضف أرقام الصفحات
- ✅ تأكد من جودة الصور والنصوص
- ✅ اضغط الملف لتقليل الحجم

### 2. التسمية
- استخدم اسم واضح للملف مثل: `Issue_2024_Vol1_No1.pdf`
- تجنب الأحرف العربية في اسم الملف

### 3. الحجم
- حاول أن يكون الملف أقل من 20MB
- استخدم أدوات ضغط PDF إذا كان الحجم كبيراً

## الصيانة

### 1. تنظيف الملفات القديمة
الملفات القديمة يتم حذفها تلقائياً من Cloudinary عند رفع ملف جديد.

### 2. مراقبة الاستخدام
يمكن مراقبة عدد مرات التحميل من خلال:
```sql
SELECT 
  issue_number,
  title,
  downloads_count,
  publish_date
FROM issues
WHERE issue_pdf_url IS NOT NULL
ORDER BY downloads_count DESC;
```

## الملاحظات

1. **الملف اختياري:** العدد يمكن نشره بدون ملف PDF كامل
2. **التحديث التلقائي:** عند رفع ملف جديد، يتم استبدال القديم تلقائياً
3. **الوصول العام:** الملف متاح للجميع بدون تسجيل دخول
4. **الإحصائيات:** يتم تتبع عدد مرات التحميل تلقائياً

## التطوير المستقبلي

- [ ] إضافة معاينة PDF في الموقع
- [ ] إضافة إمكانية تحميل أجزاء من العدد
- [ ] إضافة watermark تلقائي
- [ ] إضافة إحصائيات تفصيلية للتحميلات
- [ ] إضافة إشعار للمشتركين عند رفع عدد جديد
