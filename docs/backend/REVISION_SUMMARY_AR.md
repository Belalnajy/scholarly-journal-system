# ملخص تحديثات نظام التعديلات

## ✅ التحديثات المنفذة

### 1. خدمة التعديلات في Frontend
**الملف**: `/apps/frontend/src/services/research-revisions.service.ts`

تم إنشاء خدمة كاملة للتعامل مع التعديلات تشمل:
- إنشاء طلب تعديل جديد
- جلب التعديلات حسب البحث
- جلب آخر تعديل معلق
- إرسال التعديل مع الملف
- تحديث حالة التعديل

### 2. صفحة تعديل البحث
**الملف**: `/apps/frontend/src/pages/dashboard/ReviseResearchPage.tsx`

#### التحسينات:
✅ **تحميل البيانات الأصلية**:
- يتم جلب بيانات البحث الكاملة من قاعدة البيانات
- عرض العنوان، التخصص، رقم البحث، تاريخ التقديم
- تحميل ملاحظات التعديل المطلوبة من المحرر

✅ **عرض ملاحظات المحكمين**:
- عرض جميع التقييمات والملاحظات من المحكمين
- عرض التوصيات (قبول/رفض/تعديل)
- عرض التقييمات النجمية

✅ **نظام التعديل المتكامل**:
- رفع ملف PDF جديد (يحل محل القديم)
- كتابة ملاحظات الباحث حول التعديلات
- حفظ سجل التعديل في قاعدة البيانات
- تحديث رابط الملف في جدول البحث
- إعادة تعيين حالة المراجعات والمحكمين

✅ **معلومات إضافية**:
- عرض رقم المراجعة (Revision #1, #2, etc.)
- عرض جميع معلومات البحث الأصلي

### 3. صفحة قرار المحرر
**الملف**: `/apps/frontend/src/pages/dashboard/PendingDecisionPage.tsx`

#### التحسينات:
✅ **إنشاء طلب تعديل تلقائي**:
- عند اختيار "يتطلب تعديل"
- يتم إنشاء سجل في جدول `research_revisions`
- يتم حفظ ملاحظات المحرر
- يتم تعيين موعد تسليم (30 يوم)

✅ **تحديث حالة البحث**:
- تحديث الحالة في قاعدة البيانات
- ربط القرار بنظام التعديلات

## 🔄 تدفق العمل الكامل

### المرحلة 1: المحرر يطلب تعديلات
```
1. المحرر يفتح صفحة القرار النهائي
2. يراجع تقييمات المحكمين
3. يختار "يتطلب تعديل"
4. يكتب التعديلات المطلوبة بالتفصيل
5. يضغط "تأكيد القرار"
   ↓
   - حالة البحث → needs-revision
   - إنشاء سجل في research_revisions
   - status: pending
   - revision_number: 1 (أو يزيد تلقائياً)
```

### المرحلة 2: الباحث يقوم بالتعديل
```
1. الباحث يفتح صفحة "تعديل البحث"
2. يرى:
   - بيانات بحثه الأصلية (العنوان، التخصص، رقم البحث)
   - ملاحظات المحكمين الكاملة
   - التعديلات المطلوبة من المحرر
3. يرفع ملف PDF جديد
4. يكتب ملاحظاته حول التعديلات
5. يضغط "إرسال النسخة المعدلة"
   ↓
   - تحديث سجل التعديل → status: submitted
   - تحديث file_url في جدول research
   - إعادة تعيين المراجعات → status: pending
   - إعادة تعيين المحكمين → status: accepted
   - حالة البحث → under-review
```

### المرحلة 3: المحكمون يراجعون النسخة المعدلة
```
1. المحكمون يرون البحث في لوحتهم مرة أخرى
2. يراجعون النسخة الجديدة
3. يقدمون تقييماتهم
4. العملية تتكرر حتى القبول أو الرفض النهائي
```

## 📊 البيانات المحفوظة

### جدول research_revisions
```typescript
{
  id: "uuid",
  research_id: "uuid",
  revision_number: 1,  // يزيد تلقائياً
  revision_notes: "التعديلات المطلوبة من المحرر",
  file_url: "رابط الملف المعدل",
  status: "pending | submitted | approved | rejected",
  deadline: "2024-03-15",
  submitted_at: "2024-02-20",
  created_at: "2024-02-15"
}
```

### جدول research (التحديثات)
```typescript
{
  file_url: "رابط الملف الجديد",  // يتم تحديثه
  status: "under-review",          // يتم تحديثه
  updated_at: "2024-02-20"         // يتم تحديثه تلقائياً
}
```

## 🎯 المميزات الرئيسية

### ✅ تحميل البيانات الأصلية
- الباحث يرى جميع بيانات بحثه الأصلية
- لا يحتاج لإعادة كتابة العنوان أو التخصص
- يركز فقط على التعديلات المطلوبة

### ✅ تتبع التعديلات
- كل تعديل له رقم (Revision #1, #2, etc.)
- يتم حفظ تاريخ كل تعديل
- يمكن الرجوع للتعديلات السابقة

### ✅ الملف الجديد يحل محل القديم
- عند رفع ملف جديد، يتم تحديث `file_url`
- النسخة الجديدة تصبح هي النسخة الرسمية
- المحكمون يراجعون النسخة الجديدة فقط

### ✅ إعادة المراجعة التلقائية
- المحكمون نفسهم يراجعون النسخة المعدلة
- لا حاجة لتعيين محكمين جدد
- يتم إعادة تعيين حالتهم تلقائياً

## 🔧 Backend Endpoints المستخدمة

### Research
- `GET /research/:id` - جلب بيانات البحث
- `PATCH /research/:id` - تحديث البحث
- `PATCH /research/:id/status` - تحديث الحالة

### Revisions
- `POST /research-revisions` - إنشاء طلب تعديل
- `GET /research-revisions?research_id=xxx&status=pending` - جلب التعديلات
- `PUT /research-revisions/:id` - تحديث التعديل
- `PUT /research-revisions/:id/submit` - إرسال التعديل

### Reviews
- `GET /reviews?research_id=xxx` - جلب المراجعات
- `PATCH /reviews/:id/status` - تحديث حالة المراجعة

### Reviewer Assignments
- `GET /reviewer-assignments?research_id=xxx` - جلب التعيينات
- `PATCH /reviewer-assignments/:id/status` - تحديث حالة التعيين

## ⚠️ ملاحظات مهمة

### 1. رفع الملفات
حالياً يتم إنشاء URL وهمي. يجب تطبيق رفع فعلي:
```typescript
// في ReviseResearchPage.tsx - السطر 103
// TODO: استبدال بـ S3 أو Cloudinary
const newFileUrl = `https://storage.example.com/...`;
```

### 2. الإشعارات
يجب إضافة:
- إشعار للباحث عند طلب التعديل
- إشعار للمحكمين عند إرسال النسخة المعدلة
- إشعار للمحرر عند اكتمال المراجعات

### 3. Deadline
- يتم تعيين 30 يوم تلقائياً
- يمكن تخصيصه من قبل المحرر
- يجب إضافة تنبيهات

## 📝 الخطوات التالية (اختياري)

### 1. تحسينات UI
- [ ] عرض تاريخ جميع التعديلات
- [ ] مقارنة بين النسخ المختلفة
- [ ] تحميل النسخ السابقة

### 2. الإشعارات
- [ ] إشعارات بريد إلكتروني
- [ ] إشعارات داخل النظام
- [ ] تنبيهات الـ deadline

### 3. رفع الملفات
- [ ] تكامل مع S3/Cloudinary
- [ ] Progress bar للرفع
- [ ] معاينة PDF

### 4. التقارير
- [ ] عدد التعديلات لكل بحث
- [ ] متوسط وقت التعديل
- [ ] إحصائيات التعديلات

## ✅ الخلاصة

النظام الآن يعمل بشكل متكامل:
1. ✅ تحميل البيانات الأصلية من قاعدة البيانات
2. ✅ عرض ملاحظات المحكمين والتعديلات المطلوبة
3. ✅ رفع ملف جديد يحل محل القديم
4. ✅ حفظ سجل التعديلات في قاعدة البيانات
5. ✅ إعادة تعيين المراجعات والمحكمين تلقائياً
6. ✅ تتبع رقم المراجعة
7. ✅ إنشاء طلب تعديل تلقائي من المحرر

الباحث الآن يمكنه رؤية جميع بيانات بحثه الأصلية والتعديلات المطلوبة، ورفع نسخة معدلة تحل محل النسخة القديمة في النظام بشكل صحيح.
