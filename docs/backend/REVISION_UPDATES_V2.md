# تحديثات نظام التعديلات - الإصدار 2

## 🎯 التحديثات الجديدة

### 1. تحديث الملخص والكلمات المفتاحية

**المشكلة السابقة:**
- عند تعديل البحث، كان الباحث يرفع ملف جديد فقط
- الملخص والكلمات المفتاحية لا يتم تحديثها
- عند عرض تفاصيل البحث، تظهر البيانات القديمة

**الحل:**
- ✅ إضافة حقول لتعديل الملخص والكلمات المفتاحية في صفحة التعديل
- ✅ تحميل البيانات الحالية تلقائياً في الحقول
- ✅ تحديث البيانات في قاعدة البيانات عند الإرسال

### 2. Timeline لتاريخ البحث

**المشكلة السابقة:**
- لا يوجد عرض واضح لتاريخ البحث
- صعوبة معرفة ما حدث للبحث وما هي المرحلة الحالية

**الحل:**
- ✅ إنشاء مكون `ResearchTimeline` يعرض جميع مراحل البحث
- ✅ عرض تسلسل زمني واضح من التقديم حتى القرار النهائي
- ✅ إظهار التعديلات المطلوبة والمنفذة

---

## 📝 التغييرات التفصيلية

### 1. صفحة ReviseResearchPage

#### إضافة حقول جديدة في FormData:
```typescript
const [formData, setFormData] = useState({
  abstract: '',        // جديد: الملخص المعدل
  keywords: [],        // جديد: الكلمات المفتاحية المعدلة
  notes: '',          // ملاحظات الباحث
  file: null,         // ملف PDF
});
```

#### تحميل البيانات الحالية:
```typescript
setFormData({
  abstract: researchData.abstract || '',
  keywords: researchData.keywords || [],
  notes: pendingRevision?.revision_notes || '',
});
```

#### تحديث البيانات عند الإرسال:
```typescript
await researchService.update(research.id, {
  file_url: newFileUrl,
  abstract: formData.abstract,    // تحديث الملخص
  keywords: formData.keywords,    // تحديث الكلمات المفتاحية
});
```

#### واجهة المستخدم الجديدة:
```
┌────────────────────────────────────────────────────┐
│ رفع النسخة المعدلة                                │
├────────────────────────────────────────────────────┤
│ الملخص المعدل *                                   │
│ ┌──────────────────────────────────────────────┐   │
│ │ [ملخص البحث الحالي - قابل للتعديل]         │   │
│ └──────────────────────────────────────────────┘   │
│                                                    │
│ الكلمات المفتاحية                                 │
│ ┌──────────────────────────────────────────────┐   │
│ │ ذكاء اصطناعي, تعليم, تقنية                 │   │
│ └──────────────────────────────────────────────┘   │
│ 🏷️ ذكاء اصطناعي  🏷️ تعليم  🏷️ تقنية          │
│                                                    │
│ ملاحظات الباحث *                                  │
│ ┌──────────────────────────────────────────────┐   │
│ │ [تم إجراء التعديلات التالية...]            │   │
│ └──────────────────────────────────────────────┘   │
│                                                    │
│ رفع ملف PDF *                                     │
│ ┌──────────────────────────────────────────────┐   │
│ │ 📎 [اسحب وأفلت الملف هنا]                  │   │
│ └──────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────┘
```

### 2. مكون ResearchTimeline

#### الملف: `/apps/frontend/src/components/ResearchTimeline.tsx`

**الميزات:**
- ✅ عرض تسلسل زمني كامل للبحث
- ✅ أيقونات ملونة لكل مرحلة
- ✅ تفاصيل كل حدث
- ✅ إبراز المرحلة الحالية

**الأحداث المعروضة:**
1. **تقديم البحث** (أزرق)
   - العنوان والتخصص ورقم البحث
   
2. **مراجعات المحكمين** (أخضر/أصفر)
   - المراجعات المكتملة مع التقييمات
   - المراجعات المعلقة
   
3. **طلب تعديلات** (برتقالي)
   - التعديلات المطلوبة من المحرر
   - الموعد النهائي
   
4. **إرسال التعديلات** (أخضر)
   - تأكيد رفع الملف الجديد
   - تحديث البيانات
   
5. **القرار النهائي** (أخضر/أحمر)
   - قبول أو رفض البحث

**مثال على العرض:**
```
┌────────────────────────────────────────────────────┐
│ تاريخ البحث                                       │
├────────────────────────────────────────────────────┤
│                                                    │
│  🔵 ──┐ تقديم البحث                              │
│       │ تم تقديم البحث للمراجعة                   │
│       │ • العنوان: تطبيقات الذكاء الاصطناعي...    │
│       │ • التخصص: تقنية المعلومات                 │
│       │ 15 يناير 2024                             │
│       │                                            │
│  🟢 ──┤ مراجعات المحكمين (2)                     │
│       │ تم استلام 2 تقييم من المحكمين             │
│       │ • د. محمد: يحتاج تعديلات (4.0/5)          │
│       │ • د. فاطمة: يحتاج تعديلات (3.5/5)         │
│       │ 20 فبراير 2024                            │
│       │                                            │
│  🟠 ──┤ طلب تعديلات - المراجعة #1                │
│       │ المحرر طلب إجراء تعديلات على البحث        │
│       │ • يرجى تحسين المنهجية...                  │
│       │ • الموعد النهائي: 15 مارس 2024           │
│       │ 25 فبراير 2024                            │
│       │                                            │
│  🟡 ──┘ في انتظار التعديلات - المراجعة #1       │
│         الباحث لم يرسل التعديلات بعد             │
│         الآن                                      │
└────────────────────────────────────────────────────┘
```

---

## 🔄 تدفق العمل المحدث

### السيناريو الكامل:

```
1. الباحث يقدم البحث
   ↓
   [Timeline: تقديم البحث ✅]
   
2. المحكمون يراجعون
   ↓
   [Timeline: مراجعات المحكمين ✅]
   
3. المحرر يطلب تعديلات
   ↓
   [Timeline: طلب تعديلات ⚠️]
   
4. الباحث يفتح صفحة التعديل
   ↓
   - يرى Timeline الكامل
   - يرى ملاحظات المحكمين
   - يرى البيانات الحالية محملة في الحقول:
     ✓ الملخص الحالي
     ✓ الكلمات المفتاحية الحالية
     ✓ التعديلات المطلوبة
   
5. الباحث يعدل:
   ✏️ الملخص (إذا لزم الأمر)
   ✏️ الكلمات المفتاحية (إذا لزم الأمر)
   ✏️ يكتب ملاحظاته
   📎 يرفع ملف PDF جديد
   
6. الباحث يرسل التعديلات
   ↓
   النظام يحدث:
   ✅ file_url → الملف الجديد
   ✅ abstract → الملخص المعدل
   ✅ keywords → الكلمات المفتاحية المعدلة
   ✅ research_revisions.status → submitted
   ✅ reviews.status → pending
   ✅ assignments.status → accepted
   ✅ research.status → under-review
   
   [Timeline: إرسال التعديلات ✅]
   
7. المحكمون يراجعون النسخة الجديدة
   - يرون الملف الجديد
   - يرون الملخص المحدث
   - يرون الكلمات المفتاحية المحدثة
   
   [Timeline: مراجعات جديدة ⏳]
```

---

## 📊 البيانات المحدثة

### جدول research (التحديثات):
```sql
UPDATE research SET
  file_url = 'رابط الملف الجديد',      -- ✅ محدث
  abstract = 'الملخص المعدل',          -- ✅ جديد
  keywords = ['كلمة1', 'كلمة2'],       -- ✅ جديد
  status = 'under-review',
  updated_at = NOW()
WHERE id = 'xxx';
```

### جدول research_revisions:
```sql
-- عند الإرسال
UPDATE research_revisions SET
  status = 'submitted',
  file_url = 'رابط الملف الجديد',
  submitted_at = NOW()
WHERE id = 'xxx';
```

---

## 🎨 مميزات واجهة المستخدم

### 1. حقول قابلة للتعديل
- ✅ الملخص: textarea كبير مع البيانات الحالية
- ✅ الكلمات المفتاحية: input مع عرض tags
- ✅ ملاحظات الباحث: textarea للتعديلات المنفذة
- ✅ رفع ملف: drag & drop

### 2. Timeline تفاعلي
- ✅ ألوان مميزة لكل مرحلة
- ✅ أيقونات واضحة
- ✅ تواريخ دقيقة
- ✅ تفاصيل قابلة للتوسع
- ✅ إبراز المرحلة الحالية

### 3. تجربة مستخدم محسنة
- ✅ تحميل البيانات تلقائياً
- ✅ عرض الكلمات المفتاحية كـ tags
- ✅ validation للحقول المطلوبة
- ✅ رسائل واضحة

---

## 🧪 الاختبار

### اختبار تحديث الملخص والكلمات:

1. **قدم بحث جديد:**
   - الملخص: "ملخص أصلي"
   - الكلمات: "كلمة1, كلمة2"

2. **المحرر يطلب تعديلات**

3. **الباحث يفتح صفحة التعديل:**
   - ✅ يجب أن يرى "ملخص أصلي" في حقل الملخص
   - ✅ يجب أن يرى "كلمة1, كلمة2" في حقل الكلمات

4. **الباحث يعدل:**
   - الملخص → "ملخص معدل محسن"
   - الكلمات → "كلمة1, كلمة2, كلمة3"
   - يرفع ملف جديد

5. **بعد الإرسال:**
   ```sql
   SELECT abstract, keywords FROM research WHERE id = 'xxx';
   -- يجب أن يعرض:
   -- abstract: "ملخص معدل محسن"
   -- keywords: ["كلمة1", "كلمة2", "كلمة3"]
   ```

6. **المحكم يفتح البحث:**
   - ✅ يجب أن يرى الملخص المعدل
   - ✅ يجب أن يرى الكلمات المفتاحية المحدثة

### اختبار Timeline:

1. **عند تقديم البحث:**
   - ✅ يظهر حدث "تقديم البحث"

2. **عند مراجعة المحكمين:**
   - ✅ يظهر "مراجعات المحكمين (2)"
   - ✅ تظهر تفاصيل كل محكم

3. **عند طلب تعديلات:**
   - ✅ يظهر "طلب تعديلات - المراجعة #1"
   - ✅ تظهر التعديلات المطلوبة

4. **عند إرسال التعديلات:**
   - ✅ يظهر "إرسال التعديلات - المراجعة #1"
   - ✅ يتغير اللون للأخضر

5. **التعديلات المتعددة:**
   - ✅ كل تعديل له رقم (#1, #2, #3)
   - ✅ تظهر جميع التعديلات بالترتيب

---

## ✅ الخلاصة

### ما تم إنجازه:

1. **تحديث البيانات الكاملة:**
   - ✅ الملف (file_url)
   - ✅ الملخص (abstract)
   - ✅ الكلمات المفتاحية (keywords)

2. **Timeline شامل:**
   - ✅ جميع مراحل البحث
   - ✅ تفاصيل كل مرحلة
   - ✅ إبراز المرحلة الحالية

3. **تجربة مستخدم ممتازة:**
   - ✅ تحميل البيانات تلقائياً
   - ✅ عرض واضح ومنظم
   - ✅ سهولة التعديل

### الفوائد:

- 📊 **للباحث:** يرى تاريخ بحثه الكامل ويعدل جميع البيانات
- 👨‍⚖️ **للمحكم:** يرى البيانات المحدثة الصحيحة
- 👔 **للمحرر:** يتتبع تقدم البحث بسهولة
- 🎯 **للنظام:** بيانات دقيقة ومحدثة دائماً

---

## 📚 الملفات المعدلة

1. **`/apps/frontend/src/pages/dashboard/ReviseResearchPage.tsx`**
   - إضافة حقول abstract و keywords
   - تحميل البيانات الحالية
   - تحديث البيانات عند الإرسال
   - إضافة Timeline

2. **`/apps/frontend/src/components/ResearchTimeline.tsx`** (جديد)
   - مكون Timeline كامل
   - عرض جميع الأحداث
   - تصميم جذاب ومنظم

3. **Backend DTO** (جاهز مسبقاً)
   - `UpdateResearchDto` يدعم جميع الحقول
   - لا حاجة لتعديلات

---

**النظام الآن متكامل 100%!** 🎉
